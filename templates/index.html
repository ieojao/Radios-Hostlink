{% extends "base.html" %}

{% block title %}{{ config.nome_site }} - Home{% endblock %}

{% block content %}
<!-- Banner de programação -->
<section class="banner">
    <h1>PROGRAMAÇÃO</h1>
</section>

<!-- Tabs de dias da semana -->
<section class="programacao">
    <div class="tabs">
        <button class="tab active" data-dia="DOMINGO">DOMINGO</button>
        <button class="tab" data-dia="SEGUNDA">SEGUNDA</button>
        <button class="tab" data-dia="TERÇA">TERÇA</button>
        <button class="tab" data-dia="QUARTA">QUARTA</button>
        <button class="tab" data-dia="QUINTA">QUINTA</button>
        <button class="tab" data-dia="SEXTA">SEXTA</button>
        <button class="tab" data-dia="SÁBADO">SÁBADO</button>
    </div>
    
    <div class="programa-atual" id="programa-atual-container">
        <div class="programa-status">
            <div class="status-indicator" id="status-indicator">
                <span class="status-dot"></span>
                <span class="status-text" id="status-text">Carregando...</span>
            </div>
            <div class="tempo-restante" id="tempo-restante" style="display: none;">
                <span class="tempo-label">Termina em:</span>
                <span class="tempo-valor" id="tempo-valor">--:--</span>
            </div>
        </div>
        
        <div class="programa-content">
            <img id="programa-imagem" src="{{ url_for('static', filename='images/programa.jpg') }}" alt="Programa atual">
            <div class="programa-info">
                <span class="rolando-agora" id="rolando-agora">{{ config.programacao_rolando_agora }}</span>
                <h2 id="programa-titulo">{{ config.programacao_padrao_titulo }}</h2>
                <p id="programa-descricao">{{ config.programacao_padrao_descricao }}</p>
                <span class="horario" id="programa-horario">{{ config.programacao_padrao_horario }}</span>
            </div>
        </div>
        
        <div class="programa-proximo" id="programa-proximo" style="display: none;">
            <div class="proximo-indicator">
                <span class="proximo-label">Próximo:</span>
                <span class="proximo-titulo" id="proximo-titulo"></span>
                <span class="proximo-horario" id="proximo-horario"></span>
            </div>
        </div>
    </div>

    <!-- Grade de programação -->
    <div class="grade-programacao">
        <div id="programacao-hoje" class="programacao-dia">
            <!-- Será carregado via JavaScript -->
        </div>
    </div>
</section>

<!-- Seção de destaques -->
<section class="destaques">
    <h2>DESTAQUES</h2>
    <div class="cards">
        {% if destaques %}
            {% for destaque in destaques %}
            <div class="card">
                <img src="{{ destaque.imagem if destaque.imagem else url_for('static', filename='images/destaque' + loop.index|string + '.jpg') }}" alt="{{ destaque.titulo }}">
                <h3>{{ destaque.titulo }}</h3>
                <p>{{ destaque.descricao }}</p>
                {% if destaque.link %}
                <a href="{{ destaque.link }}" class="card-link" target="_blank">Saiba mais</a>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <!-- Destaques padrão caso não haja dados no banco -->
            <div class="card">
                <img src="{{ url_for('static', filename='images/destaque1.jpg') }}" alt="Destaque 1">
                <h3>Programa da Manhã</h3>
                <p>Comece seu dia com louvor e adoração</p>
            </div>
            <div class="card">
                <img src="{{ url_for('static', filename='images/destaque2.jpg') }}" alt="Destaque 2">
                <h3>Show da Tarde</h3>
                <p>Música gospel para animar sua tarde</p>
            </div>
            <div class="card">
                <img src="{{ url_for('static', filename='images/destaque3.jpg') }}" alt="Destaque 3">
                <h3>Louvor da Noite</h3>
                <p>Encerre seu dia com gratidão</p>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tab');
    const programacaoContainer = document.getElementById('programacao-hoje');
    
    // Função para carregar programação de um dia específico
    function carregarProgramacao(dia) {
        fetch(`/api/programacao-dia/${dia}`)
            .then(response => response.json())
            .then(data => {
                if (data.programacoes && data.programacoes.length > 0) {
                    let html = '<div class="programas-lista">';
                    data.programacoes.forEach(programa => {
                        const horaInicio = programa.horario_inicio;
                        const horaFim = programa.horario_fim;
                        const isAtual = programa.is_atual;
                        const isProximo = programa.is_proximo;
                        const status = programa.status;
                        const tempoRestante = programa.tempo_restante;
                        
                        let statusClass = '';
                        let statusText = '';
                        let tempoHtml = '';
                        
                        if (isAtual) {
                            statusClass = 'atual';
                            statusText = '<span class="ao-vivo">AO VIVO</span>';
                            if (tempoRestante) {
                                tempoHtml = `<div class="tempo-programa">
                                    <span class="tempo-label">Termina em:</span>
                                    <span class="tempo-valor">${tempoRestante.minutos.toString().padStart(2, '0')}:${tempoRestante.segundos.toString().padStart(2, '0')}</span>
                                </div>`;
                            }
                        } else if (isProximo) {
                            statusClass = 'proximo';
                            statusText = '<span class="proximo-indicator">PRÓXIMO</span>';
                        }
                        
                        html += `
                            <div class="programa-item ${statusClass}">
                                <div class="horario">
                                    <span class="hora-inicio">${horaInicio}</span>
                                    <span class="hora-fim">${horaFim}</span>
                                </div>
                                <div class="programa-info">
                                    <h3>${programa.titulo}</h3>
                                    <p>${programa.descricao || 'Programa especial'}</p>
                                    ${statusText}
                                    ${tempoHtml}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    programacaoContainer.innerHTML = html;
                    
                    // Atualizar contador de programas
                    const totalProgramas = document.getElementById('total-programas');
                    if (totalProgramas) {
                        totalProgramas.textContent = data.total_programas;
                    }
                } else {
                    programacaoContainer.innerHTML = '<p class="sem-programacao">Nenhuma programação cadastrada para este dia.</p>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar programação:', error);
                programacaoContainer.innerHTML = '<p class="erro">Erro ao carregar programação.</p>';
            });
    }
    
    // Event listeners para as tabs
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remover classe active de todas as tabs
            tabs.forEach(t => t.classList.remove('active'));
            // Adicionar classe active na tab clicada
            this.classList.add('active');
            
            // Carregar programação do dia selecionado
            const dia = this.getAttribute('data-dia');
            carregarProgramacao(dia);
        });
    });
    
    // Carregar programação do dia atual por padrão
    const hoje = new Date();
    const diasSemana = ['DOMINGO', 'SEGUNDA', 'TERÇA', 'QUARTA', 'QUINTA', 'SEXTA', 'SÁBADO'];
    const diaAtual = diasSemana[hoje.getDay()];
    
    // Ativar tab do dia atual
    const tabAtual = document.querySelector(`[data-dia="${diaAtual}"]`);
    if (tabAtual) {
        tabAtual.classList.add('active');
        carregarProgramacao(diaAtual);
    }

    // Atualizar programação atual via API
    function atualizarProgramacaoAtual() {
        fetch('/api/programacao-atual')
            .then(response => response.json())
            .then(data => {
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                const tempoRestante = document.getElementById('tempo-restante');
                const tempoValor = document.getElementById('tempo-valor');
                const programaProximo = document.getElementById('programa-proximo');
                const proximoTitulo = document.getElementById('proximo-titulo');
                const proximoHorario = document.getElementById('proximo-horario');
                
                if (data.error) {
                    statusText.textContent = 'Sem programação';
                    statusIndicator.className = 'status-indicator sem-programacao';
                    tempoRestante.style.display = 'none';
                    programaProximo.style.display = 'none';
                } else {
                    // Atualizar informações da programação atual
                    const titulo = document.getElementById('programa-titulo');
                    const descricao = document.getElementById('programa-descricao');
                    const horario = document.getElementById('programa-horario');
                    const imagem = document.getElementById('programa-imagem');
                    const rolandoAgora = document.getElementById('rolando-agora');
                    
                    if (titulo) titulo.textContent = data.titulo;
                    if (descricao) descricao.textContent = data.descricao;
                    if (horario) horario.textContent = `${data.horario_inicio} - ${data.horario_fim}`;
                    
                    // Atualizar imagem se disponível
                    if (data.imagem && imagem) {
                        if (data.imagem.startsWith('http')) {
                            imagem.src = data.imagem;
                        } else if (data.imagem.startsWith('/static/')) {
                            imagem.src = data.imagem;
                        } else {
                            imagem.src = `/static/uploads/programacao/${data.imagem}`;
                        }
                    }
                    
                    // Atualizar status
                    if (data.status === 'ao_vivo') {
                        statusText.textContent = 'AO VIVO';
                        statusIndicator.className = 'status-indicator ao-vivo';
                        rolandoAgora.textContent = 'ROLANDO AGORA';
                        
                        // Mostrar tempo restante
                        if (data.tempo_restante) {
                            tempoRestante.style.display = 'flex';
                            atualizarTempoRestante(data.tempo_restante);
                        }
                    } else if (data.status === 'proximo') {
                        statusText.textContent = 'PRÓXIMO';
                        statusIndicator.className = 'status-indicator proximo';
                        rolandoAgora.textContent = 'EM BREVE';
                        tempoRestante.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao buscar programação:', error);
                document.getElementById('status-text').textContent = 'Erro ao carregar';
                document.getElementById('status-indicator').className = 'status-indicator erro';
            });
    }
    
    // Função para atualizar tempo restante
    function atualizarTempoRestante(tempoInicial) {
        const tempoValor = document.getElementById('tempo-valor');
        let minutos = tempoInicial.minutos;
        let segundos = tempoInicial.segundos;
        
        const timer = setInterval(() => {
            if (segundos > 0) {
                segundos--;
            } else if (minutos > 0) {
                minutos--;
                segundos = 59;
            } else {
                clearInterval(timer);
                tempoValor.textContent = '00:00';
                // Recarregar programação quando terminar
                setTimeout(atualizarProgramacaoAtual, 1000);
                return;
            }
            
            tempoValor.textContent = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        }, 1000);
    }

    // Atualizar a cada 30 segundos para ser mais responsivo
    setInterval(atualizarProgramacaoAtual, 30000);
    
    // Atualizar timer
    function atualizarTimer() {
        const timer = document.getElementById('timer');
        if (timer) {
            const agora = new Date();
            const minutos = agora.getMinutes().toString().padStart(2, '0');
            const segundos = agora.getSeconds().toString().padStart(2, '0');
            timer.textContent = `${minutos}:${segundos}`;
        }
    }
    
    setInterval(atualizarTimer, 1000);
});
</script>
{% endblock %} 